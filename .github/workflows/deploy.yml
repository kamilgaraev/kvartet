name: Deploy to Timeweb VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    name: SSH deploy
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail
            
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π Kvartett Website..."
            
            # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            WORKDIR="/opt/kvartett-website"
            BUILD_DIR="/tmp/kvartett-build-$(date +%s)"
            REPO_SSH="git@github.com:kamilgaraev/kvartet.git"
            
            # 1. –°–æ–∑–¥–∞–µ–º —á–∏—Å—Ç—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–±–æ—Ä–∫–∏
            echo "üìÅ –°–æ–∑–¥–∞–µ–º —á–∏—Å—Ç—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–±–æ—Ä–∫–∏..."
            rm -rf "$BUILD_DIR"
            git clone "$REPO_SSH" "$BUILD_DIR"
            cd "$BUILD_DIR"
            
            # 2. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            echo "üìÇ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
            if [ ! -d "$WORKDIR" ]; then
              sudo mkdir -p "$WORKDIR"
              sudo chown "$USER":"$USER" "$WORKDIR"
            fi
            
            # 3. –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª
            echo "‚öôÔ∏è –°–æ–∑–¥–∞–µ–º .env –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
            cat > .env << 'EOF'
            # Database
            DATABASE_URL="postgresql://postgres:kvartett_password_2024@db:5432/kvartett"
            
            # NextAuth
            NEXTAUTH_SECRET="kvartett-super-secret-key-2024-production"
            NEXTAUTH_URL="http://${{ secrets.PROD_SSH_HOST }}:3000"
            
            # Admin credentials
            ADMIN_EMAIL="admin@kvartett.ru"
            ADMIN_PASSWORD="admin123"
            
            # Environment
            NODE_ENV="production"
            PORT=3000
            EOF
            
            # 4. –°–æ–∑–¥–∞–µ–º .dockerignore –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            echo "üìã –°–æ–∑–¥–∞–µ–º .dockerignore..."
            cat > .dockerignore << 'DOCKERIGNORE_EOF'
            node_modules
            .next
            .git
            .gitignore
            README.md
            Dockerfile
            .dockerignore
            npm-debug.log*
            yarn-debug.log*
            yarn-error.log*
            .env*.local
            .vercel
            *.tgz
            *.tar.gz
            .cache
            public/sw.js
            public/workbox-*.js
            public/worker-*.js
            public/sw.js.map
            public/workbox-*.js.map
            public/worker-*.js.map
            .DS_Store
            Thumbs.db
            DOCKERIGNORE_EOF
            
            # 5. –°–æ–∑–¥–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Dockerfile
            echo "üê≥ –°–æ–∑–¥–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Dockerfile..."
            cat > Dockerfile << 'DOCKERFILE_EOF'
            FROM node:20-slim AS base
            
            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            FROM base AS deps
            WORKDIR /app
            COPY package.json package-lock.json* ./
            RUN npm ci --only=production && npm cache clean --force
            
            # –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            FROM base AS builder
            WORKDIR /app
            COPY --from=deps /app/node_modules ./node_modules
            COPY . .
            ENV NEXT_TELEMETRY_DISABLED=1
            RUN npm run build
            
            # –ü—Ä–æ–¥–∞–∫—à–Ω –æ–±—Ä–∞–∑
            FROM base AS runner
            WORKDIR /app
            
            ENV NODE_ENV=production
            ENV NEXT_TELEMETRY_DISABLED=1
            ENV PORT=3000
            
            RUN groupadd --gid 1001 nodejs && \
                useradd --uid 1001 --gid nodejs nextjs
            
            COPY --from=builder /app/public ./public
            COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
            COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
            
            USER nextjs
            EXPOSE 3000
            
            CMD ["node", "server.js"]
            DOCKERFILE_EOF
            
            # 5. –û–±–Ω–æ–≤–ª—è–µ–º next.config.ts –¥–ª—è standalone
            echo "üìù –û–±–Ω–æ–≤–ª—è–µ–º Next.js –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
            cat > next.config.ts << 'NEXTCONFIG_EOF'
            import type { NextConfig } from "next";
            
            const nextConfig: NextConfig = {
              output: 'standalone',
              experimental: {
                serverComponentsExternalPackages: ['@prisma/client', 'prisma']
              },
              images: {
                domains: ['ui-avatars.com', 'images.unsplash.com'],
              },
            };
            
            export default nextConfig;
            NEXTCONFIG_EOF
            
            # 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º Docker –∏ rsync
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º Docker..."
            if ! command -v docker &> /dev/null; then
              echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              sudo systemctl start docker
              sudo systemctl enable docker
            fi
            
            if ! command -v rsync &> /dev/null; then
              echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º rsync..."
              sudo apt-get update && sudo apt-get install -y rsync
            fi
            
            # 7. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker compose down || true
            
            # 8. –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker
            echo "üßπ –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É Docker..."
            docker system prune -af --volumes || true
            docker builder prune -af || true
            
            # 9. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã..."
            docker images | grep kvartett-website | awk '{print $3}' | xargs -r docker rmi -f || true
            
            # 10. –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã –≤ —á–∏—Å—Ç–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            echo "üî® –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã —Å –Ω—É–ª—è..."
            DOCKER_BUILDKIT=1 docker compose build --no-cache --pull
            
            # 11. –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            echo "üìã –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
            rsync -av --delete --exclude='.git' "$BUILD_DIR/" "$WORKDIR/"
            
            # 12. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
            cd "$WORKDIR"
            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker compose up -d
            
            # 13. –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            echo "üßπ –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
            rm -rf "$BUILD_DIR"
            
            # 14. –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
            sleep 30
            
            echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker compose ps
            
            echo "üìã –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
            docker compose logs --tail=10 app
            
            echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∞–π—Ç–∞..."
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "‚úÖ –°–∞–π—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
              echo "üîó –î–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://${{ secrets.PROD_SSH_HOST }}:3000"
            else
              echo "‚ùå –°–∞–π—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏..."
              docker compose logs app
            fi
            
            echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"


