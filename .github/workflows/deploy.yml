name: Deploy to Timeweb VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    name: SSH deploy
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail
            
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π Kvartett Website..."
            
            # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            WORKDIR="/opt/kvartett-website"
            BUILD_DIR="/tmp/kvartett-build-$(date +%s)"
            REPO_SSH="git@github.com:kamilgaraev/kvartet.git"
            
            # 1. –°–æ–∑–¥–∞–µ–º —á–∏—Å—Ç—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–±–æ—Ä–∫–∏
            echo "üìÅ –°–æ–∑–¥–∞–µ–º —á–∏—Å—Ç—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–±–æ—Ä–∫–∏..."
            rm -rf "$BUILD_DIR"
            git clone "$REPO_SSH" "$BUILD_DIR"
            cd "$BUILD_DIR"
            
            # 2. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            echo "üìÇ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
            if [ ! -d "$WORKDIR" ]; then
              sudo mkdir -p "$WORKDIR"
              sudo chown "$USER":"$USER" "$WORKDIR"
            fi
            
            # 3. –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª
            echo "‚öôÔ∏è –°–æ–∑–¥–∞–µ–º .env –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
            cat > .env << 'ENVEOF'
            # Database
            DATABASE_URL="postgresql://kvartett:kvartett_password_2024@db:5432/kvartett"
            
            # NextAuth
            NEXTAUTH_SECRET="kvartett-super-secret-key-2024-production"
            NEXTAUTH_URL="http://${{ secrets.PROD_SSH_HOST }}"
            
            # Admin credentials
            ADMIN_EMAIL="admin@kvartett.ru"
            ADMIN_PASSWORD="admin123"
            
            # Environment
            NODE_ENV="production"
            PORT=3000
            ENVEOF
            
            # 4. –ü–æ–¥–Ω–∏–º–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ Docker Compose
            echo "üê≥ –ì–æ—Ç–æ–≤–∏–º Docker network..."
            docker network create kvartett-net || true
            
            echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker rm -f kvartett-app || true
            docker rm -f kvartett-db || true
            
            echo "üóÉÔ∏è –ó–∞–ø—É—Å–∫–∞–µ–º –ë–î..."
            docker run -d \
              --name kvartett-db \
              --network kvartett-net \
              --restart unless-stopped \
              -e POSTGRES_USER=kvartett \
              -e POSTGRES_PASSWORD=kvartett_password_2024 \
              -e POSTGRES_DB=kvartett \
              postgres:16-alpine
            
            echo "‚è≥ –ñ–¥—ë–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ë–î..."
            sleep 10
            
            # 5. –û–±–Ω–æ–≤–ª—è–µ–º next.config.ts –¥–ª—è standalone
            echo "üìù –û–±–Ω–æ–≤–ª—è–µ–º Next.js –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
            cat > next.config.ts << 'NEXTCONFIGEOF'
            import type { NextConfig } from "next";
            
            const nextConfig: NextConfig = {
              output: 'standalone',
              experimental: {
                serverComponentsExternalPackages: ['@prisma/client', 'prisma']
              },
              images: {
                domains: ['ui-avatars.com', 'images.unsplash.com'],
              },
            };
            
            export default nextConfig;
            NEXTCONFIGEOF
            
            # 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º Docker –∏ rsync
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º Docker..."
            if ! command -v docker &> /dev/null; then
              echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              sudo systemctl start docker
              sudo systemctl enable docker
            fi
            
            if ! command -v rsync &> /dev/null; then
              echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º rsync..."
              sudo apt-get update && sudo apt-get install -y rsync
            fi
            
            # 7. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã  
            echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker compose down || true
            
            # 8. –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            echo "üìã –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
            rsync -av --delete --exclude='.git' "$BUILD_DIR/" "$WORKDIR/"
            
            # 9. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–±–µ–∑ compose)
            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
            docker run -d \
              --name kvartett-app \
              --network kvartett-net \
              --restart unless-stopped \
              -p 80:3000 \
              -v "$WORKDIR":/app \
              -w /app \
              -e NODE_ENV=production \
              -e NEXT_TELEMETRY_DISABLED=1 \
              -e HOSTNAME=0.0.0.0 \
              -e PORT=3000 \
              -e DATABASE_URL="postgresql://kvartett:kvartett_password_2024@kvartett-db:5432/kvartett" \
              node:20-slim \
              sh -c "apt-get update && apt-get install -y openssl ca-certificates && npm ci && npx prisma generate && npm run build && npm start -- -p 3000 -H 0.0.0.0"
            
            # 10. –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            echo "üßπ –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
            rm -rf "$BUILD_DIR"
            
            # 11. –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ HTTP (–¥–æ 10 –º–∏–Ω—É—Ç)
            echo "‚è≥ –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
            for i in $(seq 1 120); do
              if curl -fsS http://localhost/ > /dev/null 2>&1; then
                READY=1; break; fi; sleep 5; done
            
            echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Image}}'
            echo "üîí –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç 80 –∏ firewall..."
            (ss -ltnp 2>/dev/null | grep ':80 ' ) || true
            (command -v ufw >/dev/null 2>&1 && sudo ufw status verbose) || true
            (iptables -L -n | head -n 50) || true
            
            echo "üìã –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
            docker logs --tail=200 --since=1m kvartett-app || true
            
            echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∞–π—Ç–∞..."
            if [ "${READY:-0}" = "1" ]; then
              echo "‚úÖ –°–∞–π—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
              echo "üîó –î–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://${{ secrets.PROD_SSH_HOST }}"
            else
              echo "‚ùå –°–∞–π—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏..."
              docker logs kvartett-app
            fi
            
            echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"


      - name: External health check from runner
        run: |
          echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞ –∏–∑–≤–Ω–µ..."
          for i in $(seq 1 60); do
            if curl -fsS -m 5 "http://${{ secrets.PROD_SSH_HOST }}/" > /dev/null 2>&1; then
              echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ"; exit 0; fi; sleep 5; done
          echo "‚ùå –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ"; exit 1
