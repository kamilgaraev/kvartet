name: Deploy to Timeweb VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    name: SSH deploy
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail
            
            echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π Kvartett Website..."
            
            # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            WORKDIR="/opt/kvartett-website"
            REPO_SSH="git@github.com:kamilgaraev/kvartet.git"
            
            # 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            echo "üìÅ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
            if [ ! -d "$WORKDIR/.git" ]; then
              sudo mkdir -p "$WORKDIR"
              sudo chown "$USER":"$USER" "$WORKDIR"
              git clone "$REPO_SSH" "$WORKDIR"
            fi
            
            cd "$WORKDIR"
            
            # 2. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            echo "üì• –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
            git fetch --all --prune
            git reset --hard origin/main
            
            # 3. –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª
            echo "‚öôÔ∏è –°–æ–∑–¥–∞–µ–º .env –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
            cat > .env << 'EOF'
            # Database
            DATABASE_URL="postgresql://postgres:kvartett_password_2024@db:5432/kvartett"
            
            # NextAuth
            NEXTAUTH_SECRET="kvartett-super-secret-key-2024-production"
            NEXTAUTH_URL="http://${{ secrets.PROD_SSH_HOST }}:3000"
            
            # Admin credentials
            ADMIN_EMAIL="admin@kvartett.ru"
            ADMIN_PASSWORD="admin123"
            
            # Environment
            NODE_ENV="production"
            PORT=3000
            EOF
            
            # 4. –°–æ–∑–¥–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Dockerfile
            echo "üê≥ –°–æ–∑–¥–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Dockerfile..."
            cat > Dockerfile << 'DOCKERFILE_EOF'
            FROM node:20-slim AS base
            
            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            FROM base AS deps
            WORKDIR /app
            COPY package.json package-lock.json* ./
            RUN npm ci --only=production && npm cache clean --force
            
            # –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            FROM base AS builder
            WORKDIR /app
            COPY --from=deps /app/node_modules ./node_modules
            COPY . .
            ENV NEXT_TELEMETRY_DISABLED=1
            RUN npm run build
            
            # –ü—Ä–æ–¥–∞–∫—à–Ω –æ–±—Ä–∞–∑
            FROM base AS runner
            WORKDIR /app
            
            ENV NODE_ENV=production
            ENV NEXT_TELEMETRY_DISABLED=1
            ENV PORT=3000
            
            RUN groupadd --gid 1001 nodejs && \
                useradd --uid 1001 --gid nodejs nextjs
            
            COPY --from=builder /app/public ./public
            COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
            COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
            
            USER nextjs
            EXPOSE 3000
            
            CMD ["node", "server.js"]
            DOCKERFILE_EOF
            
            # 5. –û–±–Ω–æ–≤–ª—è–µ–º next.config.ts –¥–ª—è standalone
            echo "üìù –û–±–Ω–æ–≤–ª—è–µ–º Next.js –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
            cat > next.config.ts << 'NEXTCONFIG_EOF'
            import type { NextConfig } from "next";
            
            const nextConfig: NextConfig = {
              output: 'standalone',
              experimental: {
                serverComponentsExternalPackages: ['@prisma/client', 'prisma']
              },
              images: {
                domains: ['ui-avatars.com', 'images.unsplash.com'],
              },
            };
            
            export default nextConfig;
            NEXTCONFIG_EOF
            
            # 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º Docker
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º Docker..."
            if ! command -v docker &> /dev/null; then
              echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sudo sh get-docker.sh
              sudo usermod -aG docker $USER
              sudo systemctl start docker
              sudo systemctl enable docker
            fi
            
            # 7. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker compose down || true
            
            # 8. –û—á–∏—â–∞–µ–º Docker –∫–µ—à
            echo "üßπ –û—á–∏—â–∞–µ–º Docker –∫–µ—à..."
            docker system prune -f || true
            
            # 9. –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
            echo "üî® –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã..."
            docker compose build --no-cache --pull
            
            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker compose up -d
            
            # 10. –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
            sleep 30
            
            echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker compose ps
            
            echo "üìã –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
            docker compose logs --tail=10 app
            
            echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∞–π—Ç–∞..."
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "‚úÖ –°–∞–π—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
              echo "üîó –î–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://${{ secrets.PROD_SSH_HOST }}:3000"
            else
              echo "‚ùå –°–∞–π—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏..."
              docker compose logs app
            fi
            
            echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"


